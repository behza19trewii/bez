┌──────────────────────────┐
│ شروع اجرای اسکریپت (main)│
└─────────────┬────────────┘
              │
              ▼
┌──────────────────────────────────────┐
│ بارگذاری داده‌ها با تابع load_data() │
│ - بررسی وجود فایل CSV یا JSON       │
│ - در صورت نبود، تولید داده مصنوعی   │
└─────────────┬────────────────────────┘
              │
              ▼
┌──────────────────────────────────────┐
│ اجرای تابع backtest_sma()           │
│ - محاسبه SMA کوتاه و بلند           │
│ - محاسبه ATR                        │
│ - شبیه‌سازی معاملات بر اساس کراس SMA │
│ - ذخیره جزئیات ورود/خروج            │
│ خروجی: data (روزانه)، trades (معاملات) │
└─────────────┬────────────────────────┘
              │
              ▼
┌──────────────────────────────────────┐
│ محاسبه شاخص‌های عملکرد              │
│ با compute_metrics_from_equity()     │
│ شامل: بازده کل، CAGR، Sharpe، MDD...│
└─────────────┬────────────────────────┘
              │
              ▼
┌──────────────────────────────────────┐
│ محاسبه Profit Factor و آمار معاملات │
│ (win rate, avg win/loss, ...)        │
└─────────────┬────────────────────────┘
              │
              ▼
┌──────────────────────────────────────┐
│ چاپ خلاصه‌ی نتایج در کنسول          │
│ (بازده، شارپ، ضرر، سود، تعداد ترید) │
└─────────────┬────────────────────────┘
              │
              ▼
┌──────────────────────────────────────┐
│ ذخیره خروجی‌ها در فایل‌های CSV      │
│ - backtest_trades.csv               │
│ - backtest_daily.csv                │
└─────────────┬────────────────────────┘
              │
              ▼
┌──────────────────────────────────────┐
│ اجرای بهینه‌سازی (optimize_grid)     │
│ - تست چند مقدار برای ma_short و TP   │
│ - ذخیره نتایج در optimization_results.csv │
└─────────────┬────────────────────────┘
              │
              ▼
┌──────────────────────────────────────┐
│ رسم نمودارها با matplotlib           │
│ - Price + SMA + Entry/Exit           │
│ - Equity Curve                       │
│ - Trade % Returns Histogram           │
│ - Heatmap بهینه‌سازی                 │
└─────────────┬────────────────────────┘
              │
              ▼
┌──────────────────────────────────────┐
│ نمایش جدول معاملات در کنسول         │
└─────────────┬────────────────────────┘
              │
              ▼
┌──────────────────────────┐
│ پایان اجرای اسکریپت ✅   │
│ (فایل‌ها و نمودارها ذخیره شدند) │
└──────────────────────────┘
